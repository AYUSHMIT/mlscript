:NewDefs
:PreTyper
:NoJS

:dpt
fun test(x, y) = x + y
//│ process <== <root>: {fun test}
//│ | traverseTypingUnit <== <root>: {fun test}
//│ | | 1. scope = {test}
//│ | | 2. scope = {test}
//│ | | traverseFunction <== test
//│ | | | traverseTerm <== Lam(_, _)
//│ | | | | traverseTerm <== App(_, _)
//│ | | | | | traverseTerm <== Var("+")
//│ | | | | | | traverseVar(name = "+")
//│ | | | | | | | resolveVar(name = "+")
//│ | | | | | traverseTerm ==> Var("+")
//│ | | | | | traverseTerm <== Tup(_, _)
//│ | | | | | | traverseTerm <== Var("x")
//│ | | | | | | | traverseVar(name = "x")
//│ | | | | | | | | resolveVar(name = "x")
//│ | | | | | | traverseTerm ==> Var("x")
//│ | | | | | | traverseTerm <== Var("y")
//│ | | | | | | | traverseVar(name = "y")
//│ | | | | | | | | resolveVar(name = "y")
//│ | | | | | | traverseTerm ==> Var("y")
//│ | | | | | traverseTerm ==> Tup(_, _)
//│ | | | | traverseTerm ==> App(_, _)
//│ | | | traverseTerm ==> Lam(_, _)
//│ | | traverseFunction ==> test
//│ | traverseTypingUnit ==> test
//│ process ==> test
//│ fun test: (Int, Int) -> Int

:dpt
// Functions are hoisted.
let y = id(42)
fun id(x) = x
//│ process <== <root>: {let y; fun id}
//│ | traverseTypingUnit <== <root>: {let y; fun id}
//│ | | 1. scope = {id}
//│ | | traverseLetBinding(rec = false, y)
//│ | | 2. scope = {id}
//│ | | traverseFunction <== id
//│ | | | traverseTerm <== Lam(_, _)
//│ | | | | traverseTerm <== Var("x")
//│ | | | | | traverseVar(name = "x")
//│ | | | | | | resolveVar(name = "x")
//│ | | | | traverseTerm ==> Var("x")
//│ | | | traverseTerm ==> Lam(_, _)
//│ | | traverseFunction ==> id
//│ | traverseTypingUnit ==> id, y
//│ process ==> id, y
//│ let y: 42 | 'a
//│ fun id: forall 'b. ('a & 'b) -> (42 | 'b)

:dpt
// Function bodies can access variables declare after them.
fun q(x) = x + p
let p = 0
//│ process <== <root>: {fun q; let p}
//│ | traverseTypingUnit <== <root>: {fun q; let p}
//│ | | 1. scope = {q}
//│ | | traverseLetBinding(rec = false, p)
//│ | | 2. scope = {q}
//│ | | traverseFunction <== q
//│ | | | traverseTerm <== Lam(_, _)
//│ | | | | traverseTerm <== App(_, _)
//│ | | | | | traverseTerm <== Var("+")
//│ | | | | | | traverseVar(name = "+")
//│ | | | | | | | resolveVar(name = "+")
//│ | | | | | traverseTerm ==> Var("+")
//│ | | | | | traverseTerm <== Tup(_, _)
//│ | | | | | | traverseTerm <== Var("x")
//│ | | | | | | | traverseVar(name = "x")
//│ | | | | | | | | resolveVar(name = "x")
//│ | | | | | | traverseTerm ==> Var("x")
//│ | | | | | | traverseTerm <== Var("p")
//│ | | | | | | | traverseVar(name = "p")
//│ | | | | | | | | resolveVar(name = "p")
//│ | | | | | | traverseTerm ==> Var("p")
//│ | | | | | traverseTerm ==> Tup(_, _)
//│ | | | | traverseTerm ==> App(_, _)
//│ | | | traverseTerm ==> Lam(_, _)
//│ | | traverseFunction ==> q
//│ | traverseTypingUnit ==> q, p
//│ process ==> q, p
//│ fun q: Int -> Int
//│ let p: 0
