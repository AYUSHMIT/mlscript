:NoJS
// :NoProvs


class C[A]
  method In: A -> A
  method In = id
//│ Defined class C[=A]
//│ Declared C.In: C['A] -> 'A -> 'A
//│ Defined C.In: C['A] -> (forall 'a. 'a -> 'a)

def c: C[C[int]]
//│ c: C[C[int]]

def c: 'a -> C[C['a]]
//│ c: 'a -> C[C['a]]

def c: C[C['a]] -> 'a
//│ c: C[C['a]] -> 'a

def c: C['a] as 'a
//│ c: 'a
//│   where
//│     'a := C['a]

def c: C['a] | 'a as 'a
//│ c: 'a
//│   where
//│     'a :> C['a]

def c: C[C['a]] as 'a
//│ c: 'a
//│   where
//│     'a := C[C['a]]

def c: C[C['a] & 'a] as 'a
//│ c: 'a
//│   where
//│     'a := C[C['a] & 'a]

def c: C[C['a] & 'a | 'a] as 'a
//│ c: 'a
//│   where
//│     'a := C['a]

def c: C['a]
//│ c: C['a]


class C2[A]: { a: A }
  method In: A -> A
  method In = id
//│ Defined class C2[=A]
//│ Declared C2.In: C2['A] -> 'A -> 'A
//│ Defined C2.In: C2['A] -> (forall 'a. 'a -> 'a)


def mkC: 'a -> C2['a]
//│ mkC: 'a -> C2['a]

mkC' a = C2 { a }
//│ mkC': ('a & 'A) -> (C2['A] with {a: 'a})

mkC = mkC'
//│ ('a & 'A) -> (C2['A] with {a: 'a})
//│   <:  mkC:
//│ 'a -> C2['a]

rec def rc = mkC(rc)
//│ rc: 'rc
//│   where
//│     'rc :> C2['a]
//│     'a :> 'rc

rec def rc = mkC'(rc)
//│ rc: 'a
//│   where
//│     'a :> C2['A] with {a: 'a}
//│     'A :> 'a



class C3[A]: { a: C3[A] }
  method In: A -> A
  method In = id
//│ Defined class C3[=A]
//│ Declared C3.In: C3['A] -> 'A -> 'A
//│ Defined C3.In: C3['A] -> (forall 'a. 'a -> 'a)

def c: 'a -> C3['a]
//│ c: 'a -> C3['a]

rec def c a = C3 { a = c a }
//│ anything -> 'a
//│   where
//│     'a :> C3['A] with {a: 'a}
//│   <:  c:
//│ 'a -> C3['a]

rec def c (a: 'X) = C3 { a = c a: 'X }: C3['X]
//│ anything -> C3['X]
//│   <:  c:
//│ 'a -> C3['a]


class C4[A]: { a: C[C4[A]] }
  method In: A -> A
  method In = id
//│ Defined class C4[=A]
//│ Declared C4.In: C4['A] -> 'A -> 'A
//│ Defined C4.In: C4['A] -> (forall 'a. 'a -> 'a)

def c: 'a -> C4['a]
//│ c: 'a -> C4['a]

C{}
//│ res: C['A]

def c4 a = C4{ a = C{} }
//│ c4: anything -> C4['A]

def c = c4
//│ anything -> C4['A]
//│   <:  c:
//│ 'a -> C4['a]


class C5[A]: { a: C2[C5[A]] }
  method In: A -> A
  method In = id
//│ Defined class C5[=A]
//│ Declared C5.In: C5['A] -> 'A -> 'A
//│ Defined C5.In: C5['A] -> (forall 'a. 'a -> 'a)

def c: 'a -> C5['a]
//│ c: 'a -> C5['a]

rec def c5 a = C5{ a = C2 { a = c5 a } }
//│ c5: anything -> 'a
//│   where
//│     'a :> C5['A] with {a: C2['A0] with {a: 'a}}
//│     'A0 :> 'a | C5['A]
//│         <: C5['A]

c = c5
//│ anything -> 'a
//│   where
//│     'a :> C5['A] with {a: C2['A0] with {a: 'a}}
//│     'A0 :> 'a | C5['A]
//│         <: C5['A]
//│   <:  c:
//│ 'a -> C5['a]


class C6[A]: { a: C5[C6[A]] }
  method In: A -> A
  method In = id
//│ Defined class C6[=A]
//│ Declared C6.In: C6['A] -> 'A -> 'A
//│ Defined C6.In: C6['A] -> (forall 'a. 'a -> 'a)

def c: 'a -> C6['a]
//│ c: 'a -> C6['a]

rec def c6 a = C6{ a = c5 (c6 a) }
//│ c6: anything -> (C6['A] with {a: 'a})
//│   where
//│     'a :> C5[C6['A]] with {a: C2['A0] with {a: 'a}}
//│     'A0 :> 'a | C5[C6['A]]
//│         <: C5[C6['A]]

:stats
c = c6
//│ anything -> (C6['A] with {a: 'a})
//│   where
//│     'a :> C5[C6['A]] with {a: C2['A0] with {a: 'a}}
//│     'A0 :> 'a | C5[C6['A]]
//│         <: C5[C6['A]]
//│   <:  c:
//│ 'a -> C6['a]
//│ constrain calls  : 89
//│ annoying  calls  : 25
//│ subtyping calls  : 177


// Reproduction of an issue found while trying out TypeRef ctor typing:

def e: C5[C6['A]] | C5[C6['A]] & ~c5 | C5[C6['A]] | C5[C6['A]] & ~{a: C2[C5[C6['A]]]}
//│ e: C5[C6['A]]

def e: C5[C6['A]] & {a: C2[C5[C6['A]] | C5[C6['A]] & ~c5 | C5[C6['A]] | C5[C6['A]] & ~{a: C2[C5[C6['A]]]}] & {a: 'a}}
//│ e: C5[C6['A]] & {a: C2[C5[C6['A]]] & {a: nothing}}

type Inner = C5[C6['A]] & {a: C2[C5[C6['A]] | C5[C6['A]] & ~c5 | C5[C6['A]] | C5[C6['A]] & ~{a: C2[C5[C6['A]]]}] & {a: 'a}} as 'a
//│ Defined type alias Inner

def e: anything -> (C6['A] & {a: Inner})
//│ e: anything -> (C6['A] with {a: Inner})

// * The problem seems to come from Inner defining type variables, which are given level 0...
// *  This is actually the expected behavior of type vars in type aliases,
// *  but it's really weird and fishy so it should probably be rejected.
// :e // no longer an error...(?)
// :e // Fails with polymorphic RHS extrusion
// FIXME should be a cycle error
c = e
//│ anything -> (C6['A] with {a: Inner})
//│   <:  c:
//│ 'a -> C6['a]
//│ ╔══[ERROR] Subtyping constraint of the form `forall ?A. anything -> (C6[?A] with {a: Inner}) <: forall ?a. ?a -> C6[?a]` exceeded recursion depth limit (300)
//│ ║  l.206: 	c = e
//│ ║         	^^^^^
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_487)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_521)) & ~(‘a_480)) & ~(‘a_525)) & ~(‘a_508)) & ~(‘a_492)) & ~(‘a_516)) & ~(‘a_497)) & ~(‘a_518)) & ~(‘a_510)) & ~(‘a_493)) & ~(‘a_515)) & ~(‘a_481)) & ~(‘a_507)) & ~(‘a_513)) & ~(‘a_522)) & ~(‘a_496)) & ~(‘a_474)) & ~(‘a_482)) & ~(‘a_475)) & ~(‘a_517)) & ~(‘a_509)) & ~(‘a_523)) & ~(‘a_520)) & ~(‘a_526)) & ~(‘a_476)) & ~(‘a_502)) & ~(‘a_519)) & ~(‘a_489)) & ~(‘a_505)) & ~(‘a_506)) & ~(‘a_494)) & ~(‘a_503)) & ~(‘a_500)) & ~(‘a_491)) & ~(‘a_498)) & ~(‘a_479)) & ~(‘a_477)) & ~(‘a_501)) & ~(‘a_499)) & ~(‘a_527)) & ~(‘a_524)) & ~(‘a_485)) & ~(‘a_495)) & ~(‘a_484)) & ~(‘a_478)) & ~(‘a_511)) & ~(‘a_486)) & ~(‘a_528)) & ~(‘a_488)) & ~(‘a_512)) & ~(‘a_490)) & ~(‘a_529)) & ~(‘a_483)) & ~(‘a_530)) & ~(‘a_531))  <!<  ('A429 & 'A459)
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_487)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_521)) & ~(‘a_480)) & ~(‘a_525)) & ~(‘a_508)) & ~(‘a_492)) & ~(‘a_516)) & ~(‘a_497)) & ~(‘a_518)) & ~(‘a_510)) & ~(‘a_493)) & ~(‘a_515)) & ~(‘a_481)) & ~(‘a_507)) & ~(‘a_513)) & ~(‘a_522)) & ~(‘a_496)) & ~(‘a_474)) & ~(‘a_482)) & ~(‘a_475)) & ~(‘a_517)) & ~(‘a_509)) & ~(‘a_523)) & ~(‘a_520)) & ~(‘a_526)) & ~(‘a_476)) & ~(‘a_502)) & ~(‘a_519)) & ~(‘a_489)) & ~(‘a_505)) & ~(‘a_506)) & ~(‘a_494)) & ~(‘a_503)) & ~(‘a_500)) & ~(‘a_491)) & ~(‘a_498)) & ~(‘a_479)) & ~(‘a_477)) & ~(‘a_501)) & ~(‘a_499)) & ~(‘a_527)) & ~(‘a_524)) & ~(‘a_485)) & ~(‘a_495)) & ~(‘a_484)) & ~(‘a_478)) & ~(‘a_511)) & ~(‘a_486)) & ~(‘a_528)) & ~(‘a_488)) & ~(‘a_512)) & ~(‘a_490)) & ~(‘a_529)) & ~(‘a_483)) & ~(‘a_530)) & ~(‘a_531))  <!<  'A429
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_487)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_521)) & ~(‘a_480)) & ~(‘a_525)) & ~(‘a_508)) & ~(‘a_492)) & ~(‘a_516)) & ~(‘a_497)) & ~(‘a_518)) & ~(‘a_510)) & ~(‘a_493)) & ~(‘a_515)) & ~(‘a_481)) & ~(‘a_507)) & ~(‘a_513)) & ~(‘a_522)) & ~(‘a_496)) & ~(‘a_474)) & ~(‘a_482)) & ~(‘a_475)) & ~(‘a_517)) & ~(‘a_509)) & ~(‘a_523)) & ~(‘a_520)) & ~(‘a_526)) & ~(‘a_476)) & ~(‘a_502)) & ~(‘a_519)) & ~(‘a_489)) & ~(‘a_505)) & ~(‘a_506)) & ~(‘a_494)) & ~(‘a_503)) & ~(‘a_500)) & ~(‘a_491)) & ~(‘a_498)) & ~(‘a_479)) & ~(‘a_477)) & ~(‘a_501)) & ~(‘a_499)) & ~(‘a_527)) & ~(‘a_524)) & ~(‘a_485)) & ~(‘a_495)) & ~(‘a_484)) & ~(‘a_478)) & ~(‘a_511)) & ~(‘a_486)) & ~(‘a_528)) & ~(‘a_488)) & ~(‘a_512)) & ~(‘a_490)) & ~(‘a_529)) & ~(‘a_483)) & ~(‘a_530)) & ~(‘a'))  <!<  'A429
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_488)) & ~(‘a_486)) & ~(‘a_478)) & ~(‘a_495)) & ~(‘a_524)) & ~(‘a_499)) & ~(‘a_477)) & ~(‘a_498)) & ~(‘a_500)) & ~(‘a_494)) & ~(‘a_505)) & ~(‘a_519)) & ~(‘a_476)) & ~(‘a_520)) & ~(‘a_509)) & ~(‘a_475)) & ~(‘a_474)) & ~(‘a_522)) & ~(‘a_507)) & ~(‘a_515)) & ~(‘a_510)) & ~(‘a_497)) & ~(‘a_492)) & ~(‘a_525)) & ~(‘a_521)) & ~(‘a_514)) & ~(‘a_487)) & ~(‘a_504)) & ~(‘a_480)) & ~(‘a_508)) & ~(‘a_516)) & ~(‘a_518)) & ~(‘a_493)) & ~(‘a_481)) & ~(‘a_513)) & ~(‘a_496)) & ~(‘a_482)) & ~(‘a_517)) & ~(‘a_523)) & ~(‘a_526)) & ~(‘a_502)) & ~(‘a_489)) & ~(‘a_506)) & ~(‘a_503)) & ~(‘a_491)) & ~(‘a_479)) & ~(‘a_501)) & ~(‘a_527)) & ~(‘a_485)) & ~(‘a_484)) & ~(‘a_511)) & ~(‘a_528)) & ~(‘a_512)) & ~(‘a_529)) & ~(‘a_530))  <!<  ‹∀ 0. ((('a473' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_488)) & ~(‘a_486)) & ~(‘a_478)) & ~(‘a_495)) & ~(‘a_524)) & ~(‘a_499)) & ~(‘a_477)) & ~(‘a_498)) & ~(‘a_500)) & ~(‘a_494)) & ~(‘a_505)) & ~(‘a_519)) & ~(‘a_476)) & ~(‘a_520)) & ~(‘a_509)) & ~(‘a_475)) & ~(‘a_474)) & ~(‘a_522)) & ~(‘a_507)) & ~(‘a_515)) & ~(‘a_510)) & ~(‘a_497)) & ~(‘a_492)) & ~(‘a_525)) & ~(‘a_521)) & ~(‘a_514)) & ~(‘a_487)) & ~(‘a_504)) & ~(‘a_480)) & ~(‘a_508)) & ~(‘a_516)) & ~(‘a_518)) & ~(‘a_493)) & ~(‘a_481)) & ~(‘a_513)) & ~(‘a_496)) & ~(‘a_482)) & ~(‘a_517)) & ~(‘a_523)) & ~(‘a_526)) & ~(‘a_502)) & ~(‘a_489)) & ~(‘a_506)) & ~(‘a_503)) & ~(‘a_491)) & ~(‘a_479)) & ~(‘a_501)) & ~(‘a_527)) & ~(‘a_485)) & ~(‘a_484)) & ~(‘a_511)) & ~(‘a_528)) & ~(‘a_512)) & ~(‘a_529)) & ~(‘a_530))  <!<  'A459
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_488)) & ~(‘a_486)) & ~(‘a_478)) & ~(‘a_495)) & ~(‘a_524)) & ~(‘a_499)) & ~(‘a_477)) & ~(‘a_498)) & ~(‘a_500)) & ~(‘a_494)) & ~(‘a_505)) & ~(‘a_519)) & ~(‘a_476)) & ~(‘a_520)) & ~(‘a_509)) & ~(‘a_475)) & ~(‘a_474)) & ~(‘a_522)) & ~(‘a_507)) & ~(‘a_515)) & ~(‘a_510)) & ~(‘a_497)) & ~(‘a_492)) & ~(‘a_525)) & ~(‘a_521)) & ~(‘a_514)) & ~(‘a_487)) & ~(‘a_504)) & ~(‘a_480)) & ~(‘a_508)) & ~(‘a_516)) & ~(‘a_518)) & ~(‘a_493)) & ~(‘a_481)) & ~(‘a_513)) & ~(‘a_496)) & ~(‘a_482)) & ~(‘a_517)) & ~(‘a_523)) & ~(‘a_526)) & ~(‘a_502)) & ~(‘a_489)) & ~(‘a_506)) & ~(‘a_503)) & ~(‘a_491)) & ~(‘a_479)) & ~(‘a_501)) & ~(‘a_527)) & ~(‘a_485)) & ~(‘a_484)) & ~(‘a_511)) & ~(‘a_528)) & ~(‘a_512)) & ~(‘a_529)) & ~(‘a_530))  <!<  ('A429 & 'A459)
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_488)) & ~(‘a_486)) & ~(‘a_478)) & ~(‘a_495)) & ~(‘a_524)) & ~(‘a_499)) & ~(‘a_477)) & ~(‘a_498)) & ~(‘a_500)) & ~(‘a_494)) & ~(‘a_505)) & ~(‘a_519)) & ~(‘a_476)) & ~(‘a_520)) & ~(‘a_509)) & ~(‘a_475)) & ~(‘a_474)) & ~(‘a_522)) & ~(‘a_507)) & ~(‘a_515)) & ~(‘a_510)) & ~(‘a_497)) & ~(‘a_492)) & ~(‘a_525)) & ~(‘a_521)) & ~(‘a_514)) & ~(‘a_487)) & ~(‘a_504)) & ~(‘a_480)) & ~(‘a_508)) & ~(‘a_516)) & ~(‘a_518)) & ~(‘a_493)) & ~(‘a_481)) & ~(‘a_513)) & ~(‘a_496)) & ~(‘a_482)) & ~(‘a_517)) & ~(‘a_523)) & ~(‘a_526)) & ~(‘a_502)) & ~(‘a_489)) & ~(‘a_506)) & ~(‘a_503)) & ~(‘a_491)) & ~(‘a_479)) & ~(‘a_501)) & ~(‘a_527)) & ~(‘a_485)) & ~(‘a_484)) & ~(‘a_511)) & ~(‘a_528)) & ~(‘a_512)) & ~(‘a_529)) & ~(‘a_530))  <!<  'A429
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_488)) & ~(‘a_486)) & ~(‘a_478)) & ~(‘a_495)) & ~(‘a_524)) & ~(‘a_499)) & ~(‘a_477)) & ~(‘a_498)) & ~(‘a_500)) & ~(‘a_494)) & ~(‘a_505)) & ~(‘a_519)) & ~(‘a_476)) & ~(‘a_520)) & ~(‘a_509)) & ~(‘a_475)) & ~(‘a_474)) & ~(‘a_522)) & ~(‘a_507)) & ~(‘a_515)) & ~(‘a_510)) & ~(‘a_497)) & ~(‘a_492)) & ~(‘a_525)) & ~(‘a_521)) & ~(‘a_514)) & ~(‘a_487)) & ~(‘a_504)) & ~(‘a_480)) & ~(‘a_508)) & ~(‘a_516)) & ~(‘a_518)) & ~(‘a_493)) & ~(‘a_481)) & ~(‘a_513)) & ~(‘a_496)) & ~(‘a_482)) & ~(‘a_517)) & ~(‘a_523)) & ~(‘a_526)) & ~(‘a_502)) & ~(‘a_489)) & ~(‘a_506)) & ~(‘a_503)) & ~(‘a_491)) & ~(‘a_479)) & ~(‘a_501)) & ~(‘a_527)) & ~(‘a_485)) & ~(‘a_484)) & ~(‘a_511)) & ~(‘a_528)) & ~(‘a_512)) & ~(‘a_529)) & ~(‘a'))  <!<  'A429
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_512)) & ~(‘a_511)) & ~(‘a_485)) & ~(‘a_501)) & ~(‘a_491)) & ~(‘a_506)) & ~(‘a_502)) & ~(‘a_523)) & ~(‘a_482)) & ~(‘a_513)) & ~(‘a_493)) & ~(‘a_516)) & ~(‘a_480)) & ~(‘a_487)) & ~(‘a_521)) & ~(‘a_492)) & ~(‘a_510)) & ~(‘a_507)) & ~(‘a_474)) & ~(‘a_509)) & ~(‘a_476)) & ~(‘a_505)) & ~(‘a_500)) & ~(‘a_477)) & ~(‘a_524)) & ~(‘a_478)) & ~(‘a_488)) & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_486)) & ~(‘a_495)) & ~(‘a_499)) & ~(‘a_498)) & ~(‘a_494)) & ~(‘a_519)) & ~(‘a_520)) & ~(‘a_475)) & ~(‘a_522)) & ~(‘a_515)) & ~(‘a_497)) & ~(‘a_525)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_508)) & ~(‘a_518)) & ~(‘a_481)) & ~(‘a_496)) & ~(‘a_517)) & ~(‘a_526)) & ~(‘a_489)) & ~(‘a_503)) & ~(‘a_479)) & ~(‘a_527)) & ~(‘a_484)) & ~(‘a_528)) & ~(‘a_529))  <!<  ‹∀ 0. ((('a473' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_512)) & ~(‘a_511)) & ~(‘a_485)) & ~(‘a_501)) & ~(‘a_491)) & ~(‘a_506)) & ~(‘a_502)) & ~(‘a_523)) & ~(‘a_482)) & ~(‘a_513)) & ~(‘a_493)) & ~(‘a_516)) & ~(‘a_480)) & ~(‘a_487)) & ~(‘a_521)) & ~(‘a_492)) & ~(‘a_510)) & ~(‘a_507)) & ~(‘a_474)) & ~(‘a_509)) & ~(‘a_476)) & ~(‘a_505)) & ~(‘a_500)) & ~(‘a_477)) & ~(‘a_524)) & ~(‘a_478)) & ~(‘a_488)) & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_486)) & ~(‘a_495)) & ~(‘a_499)) & ~(‘a_498)) & ~(‘a_494)) & ~(‘a_519)) & ~(‘a_520)) & ~(‘a_475)) & ~(‘a_522)) & ~(‘a_515)) & ~(‘a_497)) & ~(‘a_525)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_508)) & ~(‘a_518)) & ~(‘a_481)) & ~(‘a_496)) & ~(‘a_517)) & ~(‘a_526)) & ~(‘a_489)) & ~(‘a_503)) & ~(‘a_479)) & ~(‘a_527)) & ~(‘a_484)) & ~(‘a_528)) & ~(‘a_529))  <!<  'A459
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_512)) & ~(‘a_511)) & ~(‘a_485)) & ~(‘a_501)) & ~(‘a_491)) & ~(‘a_506)) & ~(‘a_502)) & ~(‘a_523)) & ~(‘a_482)) & ~(‘a_513)) & ~(‘a_493)) & ~(‘a_516)) & ~(‘a_480)) & ~(‘a_487)) & ~(‘a_521)) & ~(‘a_492)) & ~(‘a_510)) & ~(‘a_507)) & ~(‘a_474)) & ~(‘a_509)) & ~(‘a_476)) & ~(‘a_505)) & ~(‘a_500)) & ~(‘a_477)) & ~(‘a_524)) & ~(‘a_478)) & ~(‘a_488)) & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_486)) & ~(‘a_495)) & ~(‘a_499)) & ~(‘a_498)) & ~(‘a_494)) & ~(‘a_519)) & ~(‘a_520)) & ~(‘a_475)) & ~(‘a_522)) & ~(‘a_515)) & ~(‘a_497)) & ~(‘a_525)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_508)) & ~(‘a_518)) & ~(‘a_481)) & ~(‘a_496)) & ~(‘a_517)) & ~(‘a_526)) & ~(‘a_489)) & ~(‘a_503)) & ~(‘a_479)) & ~(‘a_527)) & ~(‘a_484)) & ~(‘a_528)) & ~(‘a_529))  <!<  ('A429 & 'A459)
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_512)) & ~(‘a_511)) & ~(‘a_485)) & ~(‘a_501)) & ~(‘a_491)) & ~(‘a_506)) & ~(‘a_502)) & ~(‘a_523)) & ~(‘a_482)) & ~(‘a_513)) & ~(‘a_493)) & ~(‘a_516)) & ~(‘a_480)) & ~(‘a_487)) & ~(‘a_521)) & ~(‘a_492)) & ~(‘a_510)) & ~(‘a_507)) & ~(‘a_474)) & ~(‘a_509)) & ~(‘a_476)) & ~(‘a_505)) & ~(‘a_500)) & ~(‘a_477)) & ~(‘a_524)) & ~(‘a_478)) & ~(‘a_488)) & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_486)) & ~(‘a_495)) & ~(‘a_499)) & ~(‘a_498)) & ~(‘a_494)) & ~(‘a_519)) & ~(‘a_520)) & ~(‘a_475)) & ~(‘a_522)) & ~(‘a_515)) & ~(‘a_497)) & ~(‘a_525)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_508)) & ~(‘a_518)) & ~(‘a_481)) & ~(‘a_496)) & ~(‘a_517)) & ~(‘a_526)) & ~(‘a_489)) & ~(‘a_503)) & ~(‘a_479)) & ~(‘a_527)) & ~(‘a_484)) & ~(‘a_528)) & ~(‘a_529))  <!<  'A429
//│ ╟── while constraining:  ((((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_512)) & ~(‘a_511)) & ~(‘a_485)) & ~(‘a_501)) & ~(‘a_491)) & ~(‘a_506)) & ~(‘a_502)) & ~(‘a_523)) & ~(‘a_482)) & ~(‘a_513)) & ~(‘a_493)) & ~(‘a_516)) & ~(‘a_480)) & ~(‘a_487)) & ~(‘a_521)) & ~(‘a_492)) & ~(‘a_510)) & ~(‘a_507)) & ~(‘a_474)) & ~(‘a_509)) & ~(‘a_476)) & ~(‘a_505)) & ~(‘a_500)) & ~(‘a_477)) & ~(‘a_524)) & ~(‘a_478)) & ~(‘a_488)) & ~(‘a_483)) & ~(‘a_490)) & ~(‘a_486)) & ~(‘a_495)) & ~(‘a_499)) & ~(‘a_498)) & ~(‘a_494)) & ~(‘a_519)) & ~(‘a_520)) & ~(‘a_475)) & ~(‘a_522)) & ~(‘a_515)) & ~(‘a_497)) & ~(‘a_525)) & ~(‘a_514)) & ~(‘a_504)) & ~(‘a_508)) & ~(‘a_518)) & ~(‘a_481)) & ~(‘a_496)) & ~(‘a_517)) & ~(‘a_526)) & ~(‘a_489)) & ~(‘a_503)) & ~(‘a_479)) & ~(‘a_527)) & ~(‘a_484)) & ~(‘a_528)) & ~(‘a'))  <!<  'A429
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_484)) & ~(‘a_479)) & ~(‘a_489)) & ~(‘a_517)) & ~(‘a_481)) & ~(‘a_508)) & ~(‘a_514)) & ~(‘a_497)) & ~(‘a_522)) & ~(‘a_520)) & ~(‘a_494)) & ~(‘a_499)) & ~(‘a_486)) & ~(‘a_483)) & ~(‘a_478)) & ~(‘a_477)) & ~(‘a_505)) & ~(‘a_509)) & ~(‘a_507)) & ~(‘a_492)) & ~(‘a_487)) & ~(‘a_516)) & ~(‘a_513)) & ~(‘a_523)) & ~(‘a_506)) & ~(‘a_501)) & ~(‘a_511)) & ~(‘a_512)) & ~(‘a_485)) & ~(‘a_491)) & ~(‘a_502)) & ~(‘a_482)) & ~(‘a_493)) & ~(‘a_480)) & ~(‘a_521)) & ~(‘a_510)) & ~(‘a_474)) & ~(‘a_476)) & ~(‘a_500)) & ~(‘a_524)) & ~(‘a_488)) & ~(‘a_490)) & ~(‘a_495)) & ~(‘a_498)) & ~(‘a_519)) & ~(‘a_475)) & ~(‘a_515)) & ~(‘a_525)) & ~(‘a_504)) & ~(‘a_518)) & ~(‘a_496)) & ~(‘a_526)) & ~(‘a_503)) & ~(‘a_527)) & ~(‘a_528))  <!<  ‹∀ 0. ((('a473' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  (((((((((((((((((((((((((((((((((((((((((((((((((((((((‘a_470 & ~(‘a_484)) & ~(‘a_479)) & ~(‘a_489)) & ~(‘a_517)) & ~(‘a_481)) & ~(‘a_508)) & ~(‘a_514)) & ~(‘a_497)) & ~(‘a_522)) & ~(‘a_520)) & ~(‘a_494)) & ~(‘a_499)) & ~(‘a_486)) & ~(‘a_483)) & ~(‘a_478)) & ~(‘a_477)) & ~(‘a_505)) & ~(‘a_509)) & ~(‘a_507)) & ~(‘a_492)) & ~(‘a_487)) & ~(‘a_516)) & ~(‘a_513)) & ~(‘a_523)) & ~(‘a_506)) & ~(‘a_501)) & ~(‘a_511)) & ~(‘a_512)) & ~(‘a_485)) & ~(‘a_491)) & ~(‘a_502)) & ~(‘a_482)) & ~(‘a_493)) & ~(‘a_480)) & ~(‘a_521)) & ~(‘a_510)) & ~(‘a_474)) & ~(‘a_476)) & ~(‘a_500)) & ~(‘a_524)) & ~(‘a_488)) & ~(‘a_490)) & ~(‘a_495)) & ~(‘a_498)) & ~(‘a_519)) & ~(‘a_475)) & ~(‘a_515)) & ~(‘a_525)) & ~(‘a_504)) & ~(‘a_518)) & ~(‘a_496)) & ~(‘a_526)) & ~(‘a_503)) & ~(‘a_527)) & ~(‘a_528))  <!<  'A459
//│ ╟── ......
//│ ╟── ......
//│ ╟── while constraining:  (‘a_470 & ~(‘a_474))  <!<  'A429
//│ ╟── while constraining:  (‘a_470 & ~(‘a'))  <!<  'A429
//│ ╟── while constraining:  (‘a_470 & ~('A429))  <!<  ‹∀ 0. ((('a473' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  'A459  <!<  ‹∀ 0. ((('a473' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  'A459  <!<  (((‘a' | 'A429) | ~(‘a_470)) | ~((‘a_470 & ~('A429))))
//│ ╟── while constraining:  ((‘a_470 & ~('A429)) & 'A459)  <!<  ‹∀ 0. ('a472' | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  'A459  <!<  ‹∀ 0. ('a472' | ~((‘a_470 & ~('A429))))›
//│ ╟── while constraining:  'A459  <!<  (‘a' | ~((‘a_470 & ~('A429))))
//│ ╟── while constraining:  ((‘a_470 & ~('A429)) & 'A459)  <!<  ‹∀ 0. 'a471'›
//│ ╟── while constraining:  'A459  <!<  ‹∀ 0. 'a471'›
//│ ╟── while constraining:  'A459  <!<  ‘a'
//│ ╟── while constraining:  (C5[C6['A429]] & {a: (C2[(((C5[C6['A429]] | (C5[C6['A429]] & ~(c5<>))) | C5[C6['A429]]) | (C5[C6['A429]] & ~({a: C2[C5[C6['A429]]]})))] & {a: 'a428_445})})  <!<  ‹∀ 0. ({a: C2[C5[C6['a451'..'a452']..C6['a453'..'a454']]..C5[C6['a455'..'a456']..C6['a457'..'a458']]]} | ~((c5<> & {C5#A: mut C6['A459..'A461]..C6['A459..'A461], a: C2[C5[C6['A459..'A461]..C6['A459..'A461]]..C5[C6['A459..'A461]..C6['A459..'A461]]]})))›
//│ ╟── while constraining:  'a428_445  <!<  ‹∀ 0. ({a: C2[C5[C6['a451'..'a452']..C6['a453'..'a454']]..C5[C6['a455'..'a456']..C6['a457'..'a458']]]} | ~((c5<> & {C5#A: mut C6['A459..'A461]..C6['A459..'A461], a: C2[C5[C6['A459..'A461]..C6['A459..'A461]]..C5[C6['A459..'A461]..C6['A459..'A461]]]})))›
//│ ╟── while constraining:  'a428_445  <!<  ({a: C2[C5[C6[‘a']]]} | ~((c5<> & {C5#A: mut C6['A432_443']..C6['A432_443'], a: C2[C5[C6['A432_443']]]})))
//│ ╙── while constraining:  ‹∀ 0. ‹∀ 0. (Anything -> (C6['A432_433'] & {a: Inner}))››  <!<  ‹∀ 0. ('a351_352' -> C6['a351_352'])›

type Inner2[A] = C5[C6[A]] & {a: C2[C5[C6[A]] | C5[C6[A]] & ~c5 | C5[C6[A]] | C5[C6[A]] & ~{a: C2[C5[C6[A]]]}] & {a: Inner2[A]}}
//│ Defined type alias Inner2[=A]

def e: anything -> (C6['A] & {a: Inner2['A]})
//│ e: anything -> (C6['A] with {a: Inner2['A]})

c = e
//│ anything -> (C6['A] with {a: Inner2['A]})
//│   <:  c:
//│ 'a -> C6['a]



class N: {}
class S[T]: { v: T }
  method In: T -> ()
  method In _ = ()
type O[T] = S[T] | N
class L[T]: { h: T; t: O[L[T]] }
  method Append: T -> L[T]
  method Append elem = L { h = elem; t = S { v = this } }
//│ Defined class N
//│ Defined class S[=T]
//│ Declared S.In: S['T] -> 'T -> ()
//│ Defined S.In: S['T] -> anything -> ()
//│ Defined type alias O[=T]
//│ Defined class L[=T]
//│ Declared L.Append: L['T] -> 'T -> L['T]
//│ Defined L.Append: (L['T] & 'this) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] & {v: L['T] & 'this}})

s1 = S{v=1}:O['_]
s2 = S{v=S{v=1}}:O[O['_]]
//│ s1: O['_]
//│   where
//│     '_ :> 1
//│ s2: O[O['_]]
//│   where
//│     '_ :> 1

:e
L{h=error;t=s1}
L{h=error;t=s2}
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.286: 	L{h=error;t=s1}
//│ ║         	^^^^^^^^^^^^^^^
//│ ╟── integer literal of type `1` is not an instance of type `L`
//│ ║  l.276: 	s1 = S{v=1}:O['_]
//│ ║         	         ^
//│ ╟── Note: constraint arises from applied type reference:
//│ ║  l.264: 	class L[T]: { h: T; t: O[L[T]] }
//│ ╙──       	                         ^^^^
//│ res: error
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.287: 	L{h=error;t=s2}
//│ ║         	^^^^^^^^^^^^^^^
//│ ╟── type `S[?_]` is not an instance of type `L`
//│ ║  l.263: 	type O[T] = S[T] | N
//│ ║         	            ^^^^
//│ ╟── Note: constraint arises from applied type reference:
//│ ║  l.264: 	class L[T]: { h: T; t: O[L[T]] }
//│ ╙──       	                         ^^^^
//│ res: error

// :ds
// L.Append

// before:
//  Defined L.Append: L['T] -> ('T & 'a & 'b) -> (L['T & 'b .. 'T | 'b] with {h: 'a, t: S[L['T & 'b .. 'T | 'b] & 'c .. L['T & 'b .. 'T | 'b] | L['T] | 'c] with {v: L['T]}})

L.Append
//│ res: L['T] -> 'T -> L['T]


def append ls elem = L { h = elem; t = S { v = ls } }
//│ append: (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})

:ns
append
//│ res: forall 'a, 'b, 'v, 'T, 'c, 'h, 'T0, 't. 'a -> 'b -> 'c
//│   where
//│     'c :> l & {h: 'h, t: 't, L#T = 'T0}
//│     't :> s & {v: 'v, S#T = 'T}
//│        <: O[L['T0]]
//│     'b <: 'h
//│     'h <: 'T0
//│     'a <: 'v
//│     'v <: L['T0] & 'T
//│     'T := L['T0]

append error
//│ res: ('h & 'T) -> (L['T] with {h: 'h, t: S[L['T]] & {v: nothing}})


def append_ty: (L['T] & 'v) -> ('T & 'h) -> (L['T] & {h: 'h; t: S[L['T]] & {v: 'v}})
//│ append_ty: (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})

append_ty error
//│ res: ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] & {v: nothing}})

append_ty = append
//│ (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})
//│   <:  append_ty:
//│ (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})


// * Note: An older bug (fixed in 2a562ddfc712ab44a55a12370380ef4f1c3383cb)
// *    was dropping the bounds on T0 and generating this signature, which is too general:
def append_ty_2: (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] & {h: 'h; t: S['T0] & {v: 'v}})
//│ append_ty_2: (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] with {h: 'h, t: S['T0] with {v: 'v}})

append_ty_2 error
//│ res: ('T & 'h) -> (L['T] with {h: 'h, t: S['T0] with {v: nothing}})

:e
append_ty_2 = append
//│ (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})
//│   <:  append_ty_2:
//│ (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] with {h: 'h, t: S['T0] with {v: 'v}})
//│ ╔══[ERROR] Type mismatch in def definition:
//│ ║  l.360: 	append_ty_2 = append
//│ ║         	^^^^^^^^^^^^^^^^^^^^
//│ ╟── type `‘T0` is not an instance of type `L`
//│ ║  l.353: 	def append_ty_2: (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] & {h: 'h; t: S['T0] & {v: 'v}})
//│ ║         	                                                                          ^^^
//│ ╟── Note: constraint arises from applied type reference:
//│ ║  l.264: 	class L[T]: { h: T; t: O[L[T]] }
//│ ║         	                         ^^^^
//│ ╟── Note: class type parameter T is defined at:
//│ ║  l.260: 	class S[T]: { v: T }
//│ ╙──       	        ^

append_ty = append_ty_2
//│ (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] with {h: 'h, t: S['T0] with {v: 'v}})
//│   <:  append_ty:
//│ (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})

:e
append_ty_2 = append_ty
//│ (L['T] & 'v) -> ('T & 'h) -> (L['T] with {h: 'h, t: S[L['T]] with {v: 'v}})
//│   <:  append_ty_2:
//│ (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] with {h: 'h, t: S['T0] with {v: 'v}})
//│ ╔══[ERROR] Type mismatch in def definition:
//│ ║  l.383: 	append_ty_2 = append_ty
//│ ║         	^^^^^^^^^^^^^^^^^^^^^^^
//│ ╟── type `‘T0` is not an instance of type `L`
//│ ║  l.353: 	def append_ty_2: (L['T] & 'v & 'T0) -> ('T & 'h) -> (L['T] & {h: 'h; t: S['T0] & {v: 'v}})
//│ ║         	                                                                          ^^^
//│ ╟── Note: constraint arises from applied type reference:
//│ ║  l.339: 	def append_ty: (L['T] & 'v) -> ('T & 'h) -> (L['T] & {h: 'h; t: S[L['T]] & {v: 'v}})
//│ ╙──       	                                                                  ^^^^^


def append0 ls = L { h = 0; t = S { v = ls } }
//│ append0: (L['T] & 'v) -> (L['T] with {h: 0, t: S[L['T]] with {v: 'v}})
//│   where
//│     'T :> 0

def appendNil elem = L { h = elem; t = N{} }
//│ appendNil: ('h & 'T) -> (L['T] with {h: 'h, t: N})


S{v=1}
//│ res: S['T] & {v: 1}
//│   where
//│     'T :> 1

