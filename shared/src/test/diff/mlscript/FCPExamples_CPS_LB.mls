:NoJS

// TODO investigate why this makes many tests fail:
:GeneralizeCurriedFunctions
:NoRecursiveTypes


// ------------ Dummy classes to represent the types in the examples ------------

class List[a]
  method Get: a
//│ Defined class List[+a]
//│ Declared List.Get: List['a] -> 'a

// Used to represent `::`
def cons: 'a -> List['a] -> List['a]
//│ cons: 'a -> List['a] -> List['a]

// Used to represent `[]`
def nil: List['a]
//│ nil: List[nothing]

def concat: string -> List[string] -> string
//│ concat: string -> List[string] -> string


// ------------ Examples ------------


// (* s  starts a sequence, cps style *)
def s k = k () nil
//│ s: (() -> List[nothing] -> 'a) -> 'a

def insert v () acu k = k () (cons v acu)
//│ insert: 'a -> (forall 'a, 'a0. (() -> (forall 'a, 'a1, 'b. ((List['a1] & 'b) -> (forall 'a, 'a0, 'a1, 'b, 'a2, 'c. ((() -> List['a2 | 'a1 | 'a0 | 'a] -> 'c) -> 'c
//│   where
//│     'a <: 'a2
//│     'b <: List['a2]))
//│   where
//│     'a <: 'a1))
//│   where
//│     'a <: 'a0))

// (* x  inserts "x" in the acu *)
def x () = insert "x" ()
//│ x: () -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))

// (* We call x a 'token', in the sequence. *)

// (* e  ends the sequence. It builds a token that can be inserted in another sequence or that can be printed. *)
def e () acu = insert (concat "," acu)
//│ e: () -> List[string] -> (forall 'b, 'a. (() -> (forall 'b, 'a0, 'c. ((List['a0] & 'c) -> (forall 'b, 'a, 'a0, 'c, 'a1, 'd. ((() -> List['a1 | 'a0 | 'a | string] -> 'd) -> 'd
//│   where
//│     'b <: 'a1
//│     'c <: List['a1]))
//│   where
//│     'b <: 'a0))
//│   where
//│     'b <: 'a))


// (* Prints a token *)
def print t = t () nil (fun () -> fun r -> log (concat "," r))
//│ print: (() -> List[nothing] -> (() -> List[string] -> unit) -> 'a) -> 'a

// Added by me:
// :e // FIXME? refreshing-extr
s x x (s x x e)
//│ res: (() -> List['a | string] -> 'b) -> 'b
//│   where
//│     'c <: 'a
//│     'd <: List['a]


// :e // FIXME? refreshing-extr
def test8  = (s x x (s x x e) x (s x x x e) e)
//│ test8: () -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a0, 'a, 'c, 'a1, 'd. ((() -> List['a1 | 'a | 'a0 | string] -> 'd) -> 'd
//│   where
//│     'b <: 'a1
//│     'c <: List['a1]))
//│   where
//│     'b <: 'a))
//│   where
//│     'b <: 'a0

print test8


:e // FIXME? refreshing-extr
def test14 = (s x x x x x x x x x x x x x x e)
//│ ╔══[ERROR] Subtyping constraint of the form `?a <: (forall ?b. () -> ?b) -> ?c` took too many steps and ran out of fuel (5000)
//│ ║  l.95: 	def test14 = (s x x x x x x x x x x x x x x e)
//│ ║        	              ^^^^^^^^^^^^^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + 'a50_787'
//│ ╟──  + 'a27_795'
//│ ╟──  + 'a27_795'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  - 'a50_811'
//│ ╟──  - 'a50_811'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ╙──      	                     ^^
//│ test14: error

:e // FIXME? refreshing-extr
def test16 = (s x x x x x x x x x x x x x x x x e)
//│ ╔══[ERROR] Subtyping constraint of the form `?a <: (forall ?b. () -> ?b) -> ?c` took too many steps and ran out of fuel (5000)
//│ ║  l.155: 	def test16 = (s x x x x x x x x x x x x x x x x e)
//│ ║         	              ^^^^^^^^^^^^^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + 'a50_1004'
//│ ╟──  + 'a27_1012'
//│ ╟──  + 'a27_1012'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  - 'a50_1028'
//│ ╟──  - 'a50_1028'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ╙──      	                     ^^
//│ test16: error

// (* This is too much for the type-checker. *)
:e // FIXME? refreshing-extr
def test18 = (s x x x x x x x x x x x x x x x x x x e)
//│ ╔══[ERROR] Subtyping constraint of the form `?a <: (forall ?b. () -> ?b) -> ?c` took too many steps and ran out of fuel (5000)
//│ ║  l.216: 	def test18 = (s x x x x x x x x x x x x x x x x x x e)
//│ ║         	              ^^^^^^^^^^^^^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ║  l.45: 	def x () = insert "x" ()
//│ ║        	                  ^^^
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  + "x"<string>
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                     ^^
//│ ╟──  + 'a50_1223'
//│ ╟──  + 'a27_1231'
//│ ╟──  + 'a27_1231'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ║        	                                 ^^
//│ ╟──  - 'a50_1247'
//│ ╟──  - 'a50_1247'
//│ ║  l.16: 	def cons: 'a -> List['a] -> List['a]
//│ ╙──      	                     ^^
//│ test18: error


// (* A function that receives a token *)
def f t = (s x x t x x e)
//│ f: (() -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> (() -> List[string] -> (forall 'e, 'a1. (() -> (forall 'e, 'a2, 'f. ((List['a2] & 'f) -> (forall 'e, 'a1, 'a2, 'f, 'a3, 'g. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'g) -> 'g
//│   where
//│     'e <: 'a3
//│     'f <: List['a3]))
//│   where
//│     'e <: 'a2))
//│   where
//│     'e <: 'a1))) -> 'h) -> 'h

// (* If the token is used twice, we must reveive two arguments *)
def g t1 t2 = (s x x t1 x (s x t2 x e) e)
//│ g: (() -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> 'e -> (() -> List[string] -> (forall 'f, 'a1. (() -> (forall 'f, 'a2, 'g. ((List['a2] & 'g) -> (forall 'f, 'a1, 'a2, 'g, 'a3, 'h. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'h) -> 'h
//│   where
//│     'f <: 'a3
//│     'g <: List['a3]))
//│   where
//│     'f <: 'a2))
//│   where
//│     'f <: 'a1))) -> 'i & 'j) -> (forall 'j. ((() -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> (() -> List[string] -> (forall 'f, 'a1. (() -> (forall 'f, 'a2, 'g. ((List['a2] & 'g) -> (forall 'f, 'a1, 'a2, 'g, 'a3, 'h. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'h) -> 'h
//│   where
//│     'f <: 'a3
//│     'g <: List['a3]))
//│   where
//│     'f <: 'a2))
//│   where
//│     'f <: 'a1))) -> ('e & 'k)) -> ('l | 'i)
//│   where
//│     'j <: () -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> 'k -> (() -> List[string] -> (forall 'f, 'a1. (() -> (forall 'f, 'a2, 'g. ((List['a2] & 'g) -> (forall 'f, 'a1, 'a2, 'g, 'a3, 'h. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'h) -> 'h
//│   where
//│     'f <: 'a3
//│     'g <: List['a3]))
//│   where
//│     'f <: 'a2))
//│   where
//│     'f <: 'a1))) -> 'l))

// (* This does not type. It requires first-class polymorphism. *)
def h t = g t t
//│ h: (() -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> (() -> List[string] -> (forall 'e, 'a1. (() -> (forall 'e, 'a2, 'f. ((List['a2] & 'f) -> (forall 'e, 'a1, 'a2, 'f, 'a3, 'g. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'g) -> 'g
//│   where
//│     'e <: 'a3
//│     'f <: List['a3]))
//│   where
//│     'e <: 'a2))
//│   where
//│     'e <: 'a1))) -> 'h & () -> List["x"] -> (() -> (forall 'b, 'a, 'c. ((List['a] & 'c) -> (forall 'b, 'a, 'c, 'a0, 'd. ((() -> List["x" | 'a0 | 'a] -> 'd) -> 'd
//│   where
//│     'b <: 'a0
//│     'c <: List['a0]))
//│   where
//│     'b <: 'a))) -> 'h -> (() -> List[string] -> (forall 'e, 'a1. (() -> (forall 'e, 'a2, 'f. ((List['a2] & 'f) -> (forall 'e, 'a1, 'a2, 'f, 'a3, 'g. ((() -> List['a3 | 'a2 | 'a1 | string] -> 'g) -> 'g
//│   where
//│     'e <: 'a3
//│     'f <: List['a3]))
//│   where
//│     'e <: 'a2))
//│   where
//│     'e <: 'a1))) -> 'i) -> 'i

