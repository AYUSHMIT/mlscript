class None
class Some
//│ Defined class None
//│ Defined class Some

def Some v = Some{} with {v}
def None = None{}
//│ Some: 'a -> (Some & {v: 'a})
//│     = [Function: Some1]
//│ None: None
//│     = None {}

def flatMap = fun f -> fun opt ->
  case opt of { Some -> f opt.v | _ -> opt }
//│ flatMap: ('v -> 'a) -> (Some & {v: 'v} | 'a & ~some) -> 'a
//│        = [Function: flatMap]

f = fun x -> Some x
res = flatMap f (Some 1)
res = flatMap f None
//│ f: 'a -> (Some & {v: 'a})
//│  = [Function: f]
//│ res: Some & {v: 1}
//│    = Some { v: 1 }
//│ res: None | Some & {v: nothing}
//│    = None {}

class Lit
class Neg
class Var
class Plus
//│ Defined class Lit
//│ Defined class Neg
//│ Defined class Var
//│ Defined class Plus

rec def evalOpt = fun x -> case x of {
  | Lit ->
      Some x.v
  | Neg ->
      flatMap (fun s -> Some (0 - s)) (evalOpt x.sub)
  | Var ->
      None with {err = concat "free var: " x.nme}
  | Plus ->
      flatMap (fun l -> flatMap (fun r ->
        Some (l + r)
      ) (evalOpt x.rhs)) (evalOpt x.lhs)
  }
//│ ╔══[ERROR] Cyclic-looking constraint while typing field selection
//│ ║  l.47: 	      ) (evalOpt x.rhs)) (evalOpt x.lhs)
//│ ║        	                 ^^^^^
//│ ╟── ————————— Additional debugging info: —————————
//│ ╟── this constraint:  α131'  <:  {rhs: rhs151'}    TypeVariable  RecordType
//│ ╙──  ... looks like:  α131'  <:  {rhs: rhs150''}
//│ ╔══[ERROR] Cyclic-looking constraint while typing application
//│ ║  l.47: 	      ) (evalOpt x.rhs)) (evalOpt x.lhs)
//│ ║        	         ^^^^^^^^^^^^^
//│ ╟── ————————— Additional debugging info: —————————
//│ ╟── this constraint:  evalOpt99'  <:  ((rhs153',) -> α154')    TypeVariable  FunctionType
//│ ╙──  ... looks like:  evalOpt99'  <:  ((rhs150'',) -> α152'')
//│ ╔══[ERROR] Cyclic-looking constraint while typing application
//│ ║  l.45: 	      flatMap (fun l -> flatMap (fun r ->
//│ ║        	                        ^^^^^^^^^^^^^^^^^
//│ ║  l.46: 	        Some (l + r)
//│ ║        	^^^^^^^^^^^^^^^^^^^^
//│ ║  l.47: 	      ) (evalOpt x.rhs)) (evalOpt x.lhs)
//│ ║        	^^^^^^^^^^^^^^^^^^^^^^^
//│ ╟── ————————— Additional debugging info: —————————
//│ ╟── this constraint:  α154'  <:  α143''    TypeVariable  TypeVariable
//│ ╙──  ... looks like:  α152''  <:  α32'
//│ evalOpt: 'a -> (error | None & {err: string} | Some & {v: int})
//│   where
//│     'a <: Lit & {v: int} | Neg & {sub: 'a} | Plus & {lhs: 'a} | Var & {nme: string}
//│        = [Function: evalOpt]

evalOpt (Plus{} with {lhs = Lit{} with {v=2}; rhs = Lit{} with {v=2}})
//│ res: error | None & {err: string} | Some & {v: int}
//│    = Some { v: 4 }

