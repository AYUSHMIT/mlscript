:NoRecursiveTypes
:GeneralizeCurriedFunctions

// (* Use option -pa *)

// type sid = ['a] 'a -> 'a
type Sid = forall 'a. 'a -> 'a
//│ Defined type alias Sid

// let delta = (fun x -> x x : sid -> 'b)
// let k = ((fun x y -> y) : ['a] 'a -> sid)
def delta = (fun x -> x x) : Sid -> 'b
def delta_ = fun x -> x x
def k = (fun x -> fun y -> y) : forall 'a. 'a -> Sid
def k_ = fun x -> fun y -> y
//│ delta: Sid -> (forall 'a, 'b. ('b
//│   where
//│     'a <: 'a -> 'b))
//│      = [Function: delta]
//│ delta_: ('a -> anything & 'a) -> (forall 'a, 'b. ('b
//│   where
//│     'a <: 'a -> 'b))
//│       = [Function: delta_]
//│ k: anything -> Sid
//│  = [Function: k]
//│ k_: anything -> (forall 'a. 'a -> 'a)
//│   = [Function: k_]

// let id x = x
// let id' = (id : sid -> sid)
def id x = x
def id_ = id : Sid -> Sid
//│ id: 'a -> 'a
//│   = [Function: id]
//│ id_: Sid -> Sid
//│    = [Function: id]

// (* Next: We do not give enough information. *)
// untype fun x -> ((fun y -> y y) : 'a -> sid)
fun x -> ((fun y -> y y) : 'a -> Sid)
fun x_ -> (fun y -> y y)
//│ res: anything -> (forall 'a. ('a -> anything & 'a -> ‘a -> ‘a & 'a) -> Sid)
//│    = [Function: res]
//│ res: anything -> (forall 'a. ('a -> anything & 'a) -> (forall 'a, 'b. ('b
//│   where
//│     'a <: 'a -> 'b)))
//│    = [Function: res]

// :e // FIXME? failed with genLamBodies but works with quantif extrus
// let (delta:sid -> sid) = fun x -> x x
def delta = (fun x -> x x) : Sid -> Sid
//│ /!!!\ Uncaught error: java.util.NoSuchElementException: key not found: Sid
//│ 	at: scala.collection.immutable.BitmapIndexedMapNode.apply(HashMap.scala:635)
//│ 	at: scala.collection.immutable.HashMap.apply(HashMap.scala:132)
//│ 	at: mlscript.TyperDatatypes$TypeRef.expandWith(TyperDatatypes.scala:334)
//│ 	at: mlscript.TyperDatatypes$TypeRef.expand(TyperDatatypes.scala:332)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$65(ConstraintSolver.scala:674)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$65$adapted(ConstraintSolver.scala:432)
//│ 	at: mlscript.utils.package$GenHelper$.$bar$greater$extension(package.scala:101)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$62(ConstraintSolver.scala:432)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:30)

// let (delta:sid -> 'b) = fun x -> x x
def delta = (fun x -> x x) : Sid -> 'b
//│ delta: Sid -> (forall 'a, 'b. ('b
//│   where
//│     'a <: 'a -> 'b))
//│      = [Function: delta2]

// untype let (delta:'a -> sid) = fun x -> x x in delta
let delta = (fun x -> x x) : 'a -> Sid in delta
//│ res: ('a -> anything & 'a -> ‘a -> ‘a & 'a) -> Sid
//│    = [Function (anonymous)]
